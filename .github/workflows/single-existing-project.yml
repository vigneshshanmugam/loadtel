name: Load Single Existing Project
on:
  workflow_call:
    inputs:
      duration:
        description: 'Duration for each collector instance to run'
        required: false
        default: '1m'
        type: string
      delay_start:
        description: 'Maximum delay in seconds before starting each collector'
        required: false
        default: '10'
        type: string
      numprocs:
        description: 'Number of collector instances to run'
        required: false
        default: '5'
        type: string
      parallelism:
        description: 'Number of parallel jobs to run'
        required: false
        default: '3'
        type: string
      num_instances:
        description: 'Number of collector instances per configuration (otlp/1, otlp/2, etc.)'
        required: false
        default: '3'
        type: string
      collector_version:
        description: 'Version of the collector to use'
        required: false
        default: '0.138.0'
        type: string
      output_type:
        description: 'Output type for the collector (otlp or elasticsearch)'
        required: false
        default: 'otlp'
        type: string
    secrets:
      ENCRYPTION_KEY:
        required: true
        description: 'Encryption key for GPG decryption'
      single_existing_project_es_api_key:
        required: true
        description: 'API key for the existing Elastic Cloud observability project'
      single_existing_project_es_endpoint:
        required: true
        description: 'Elasticsearch endpoint URL for the existing project'
      global_monitoring_otlp_endpoint:
        required: false
        description: 'OTLP endpoint URL for monitoring telemetry from the OpenTelemetry collectors'
      global_monitoring_api_key:
        required: false
        description: 'API key for the monitoring OTLP endpoint'

  workflow_dispatch:
    inputs:
      duration:
        description: 'Duration for each collector instance to run'
        required: false
        default: '1m'
        type: string
      delay_start:
        description: 'Maximum delay in seconds before starting each collector'
        required: false
        default: '10'
        type: string
      numprocs:
        description: 'Number of collector instances to run'
        required: false
        default: '5'
        type: string
      parallelism:
        description: 'Number of parallel jobs to run'
        required: false
        default: '3'
        type: string
      collector_version:
        description: 'Version of the collector to use'
        required: false
        default: '0.138.0'
        type: string
      output_type:
        description: 'Output type for the collector (otlp or elasticsearch)'
        required: false
        default: 'otlp'
        type: choice
        options:
          - otlp
          - elasticsearch
      num_instances:
        description: 'Number of collector instances per configuration (hostmetrics/1, hostmetrics/2, etc.)'
        required: false
        default: '3'
        type: string

jobs:
  plan:
    name: Summarize Plan
    runs-on: ubuntu-latest
    steps:
      - name: Summarize Plan
        run: |
          echo "Output Type: ${{ inputs.output_type }}"
          echo "Duration: ${{ inputs.duration }}"
          echo "Delay Start: ${{ inputs.delay_start }}"
          echo "Number of Procs: ${{ inputs.numprocs }}"
          echo "Parallelism: ${{ inputs.parallelism }}"
          echo "Number of Instances: ${{ inputs.num_instances }}"
          echo "Collector Version: ${{ inputs.collector_version }}"
          echo "Total Collector Count: $(( ${{ inputs.num_instances }} * ${{ inputs.numprocs }} * ${{ inputs.parallelism }} ))"

  determine-parallelism:
    name: Determine Parallelism
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.determine-parallelism.outputs.matrix }}
    steps:
      - uses: actions/setup-python@v5
        with:
          python-version: 3.12
      - name: Define matrix
        id: determine-parallelism
        run: |
          echo "matrix=$(python -c 'import json; print(json.dumps(list(range(int(${{ inputs.parallelism }})))))')" >> $GITHUB_OUTPUT

  configure-collector:
    name: Configure Collector
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ needs.determine-parallelism.outputs.matrix }}
    needs:
      - determine-parallelism
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Install GPG
        run: |
            sudo apt update
            sudo apt install -y gpg

      - uses: actions/setup-python@v5
        with:
          python-version: 3.12
          cache: 'pip'

      - name: Install Supervisor
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install -r confgen/requirements.txt

      - name: Generate Config
        id: generate-config
        env:
          OTLP_API_KEY: ${{ inputs.output_type == 'otlp' && secrets.single_existing_project_otlp_api_key || '' }}
          OTLP_ENDPOINT: ${{ inputs.output_type == 'otlp' && secrets.single_existing_project_ingest_endpoint || '' }}
          ELASTICSEARCH_API_KEY: ${{ inputs.output_type == 'elasticsearch' && secrets.single_existing_project_es_api_key || '' }}
          ELASTICSEARCH_ENDPOINT: ${{ inputs.output_type == 'elasticsearch' && secrets.single_existing_project_es_endpoint || '' }}
          MONITORING_OTLP_ENDPOINT: ${{ secrets.global_monitoring_otlp_endpoint }}
          MONITORING_API_KEY: ${{ secrets.global_monitoring_api_key }}
          NUM_INSTANCES: ${{ inputs.num_instances }}
        run: |
          source .venv/bin/activate
          ./confgen/generate-collector-config.py > config.yaml
          echo ${{ secrets.ENCRYPTION_KEY }} | gpg --pinentry-mode loopback --passphrase-fd 0 -c -o config.yaml.gpg config.yaml

      - name: Upload Collector Config
        uses: actions/upload-artifact@v4
        with:
          name: collector-config
          path: config.yaml.gpg

  load-project:
    name: Run Collectors
    needs:
      - configure-collector
      - determine-parallelism
    uses: graphaelli/loadtel/.github/workflows/load.yml@main
    with:
      collector_config_artifact: collector-config
      collector_version: ${{ inputs.collector_version }}
      delay_start: ${{ inputs.delay_start }}
      duration: ${{ inputs.duration }}
      matrix: ${{ needs.determine-parallelism.outputs.matrix }}
      numprocs: ${{ inputs.numprocs }}
    secrets:
      ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
      global_monitoring_otlp_endpoint: ${{ secrets.global_monitoring_otlp_endpoint }}
      global_monitoring_api_key: ${{ secrets.global_monitoring_api_key }}

