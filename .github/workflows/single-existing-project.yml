name: Load Single Existing Project
on:
  workflow_dispatch:
    inputs:
        duration:
          description: 'Duration for each collector instance to run'
          required: false
          default: '1m'
          type: string
        delay_start:
          description: 'Maximum delay in seconds before starting each collector'
          required: false
          default: '10'
          type: string
        numprocs:
          description: 'Number of collector instances to run'
          required: false
          default: '5'
          type: string
        parallelism:
          description: 'Number of parallel jobs to run'
          required: false
          default: 3
          type: number
        collector_version:
          description: 'Version of the collector to use'
          required: false
          default: '0.138.0'
          type: string
        output_type:
          description: 'Output type for the collector (otlp or elasticsearch)'
          required: false
          default: 'otlp'
          type: choice
          options:
            - otlp
            - elasticsearch

jobs:
  determine-parallelism:
    name: Determine Parallelism
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.determine-parallelism.outputs.matrix }}
    steps:
      - uses: actions/setup-python@v5
        with:
          python-version: 3.12
      - name: Define matrix
        id: determine-parallelism
        run: |
          echo "matrix=$(python -c 'import json; print(json.dumps(list(range(${{ inputs.parallelism }}))))')" >> $GITHUB_OUTPUT

  configure-collector:
    name: Configure Collector
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ needs.determine-parallelism.outputs.matrix }}
    needs:
      - determine-parallelism
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Install GPG
        run: |
            sudo apt update
            sudo apt install -y gpg

      - name: Generate Config
        id: generate-config
        env:
          OTLP_API_KEY: ${{ inputs.output_type == 'otlp' && secrets.single_existing_project_otlp_api_key || '' }}
          OTLP_ENDPOINT: ${{ inputs.output_type == 'otlp' && secrets.single_existing_project_ingest_endpoint || '' }}
          ELASTICSEARCH_API_KEY: ${{ inputs.output_type == 'elasticsearch' && secrets.single_existing_project_es_api_key || '' }}
          ELASTICSEARCH_ENDPOINT: ${{ inputs.output_type == 'elasticsearch' && secrets.single_existing_project_es_endpoint || '' }}
          MONITORING_OTLP_ENDPOINT: ${{ secrets.global_monitoring_otlp_endpoint }}
          MONITORING_API_KEY: ${{ secrets.global_monitoring_api_key }}
        run: |
          ./confgen/generate-collector-config.sh > config.yaml
          echo ${{ secrets.ENCRYPTION_KEY }} | gpg --pinentry-mode loopback --passphrase-fd 0 -c -o config.yaml.gpg config.yaml

      - name: Upload Collector Config
        uses: actions/upload-artifact@v4
        with:
          name: collector-config
          path: config.yaml.gpg

  load-project:
    name: Run Collectors
    needs:
      - configure-collector
      - determine-parallelism
    uses: graphaelli/improved-computing-machine/.github/workflows/load.yml@main
    with:
      collector_config_artifact: collector-config
      collector_version: ${{ inputs.collector_version }}
      delay_start: ${{ inputs.delay_start }}
      duration: ${{ inputs.duration }}
      matrix: ${{ needs.determine-parallelism.outputs.matrix }}
      numprocs: ${{ inputs.numprocs }}
    secrets:
      ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}

